name: Scheduled Availability Check

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */1 * * *'  # Runs every hour
  workflow_dispatch:        # Allows manual trigger

jobs:
  check-availability:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Inso CLI
        uses: kong/setup-inso@v1
        with:
          inso-version: 10.1.1
          wrapper: true
      
      - name: Run Tests
        id: run_tests
        run: inso run test "Your-Test-Suite-Name" --src ./specs/appointment-checker.json
        continue-on-error: true

      - name: Discord notification
        if: success() || failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_USERNAME: "Appointment Checker"
          DISCORD_AVATAR: "https://github.com/github.png"
          DISCORD_EMBEDS: |
            [
              {
                "title": "${{ steps.run_tests.outcome == 'success' && '✅ Available Dates Found!' || '❌ No Available Dates' }}",
                "description": "```\nStdout:\n${{ steps.run_tests.outputs.stdout }}\n\nStderr:\n${{ steps.run_tests.outputs.stderr }}```",
                "color": ${{ steps.run_tests.outcome == 'success' && 65280 || 16711680 }},
                "footer": {
                  "text": "Check ran at ${{ github.event.schedule || 'Manual Trigger' }}"
                }
              }
            ]
        uses: Ilshidur/action-discord@0.3.2
        with:
          args: "Appointment availability check completed"